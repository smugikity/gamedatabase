{% extends 'base.html' %}
{% load static %}
{% block content %}


<link rel="stylesheet" type="text/css" href="{% static 'css/list.css' %}" />
{% verbatim script %}
<!-- Modal -->
<div class="modal" id="viewModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg modal-dialog-centered">
	<div class="modal-content">
		<div class="modal-body movie-card-container d-flex" id="modal-container" style="word-break: break-word;">
			<img src="/media/loading.gif" alt="Loading" style="width: 200px; height: 200px; margin-left: auto; margin-right: auto; margin-top: auto; margin-bottom: auto;">
		</div>
	</div>
</div>
</div>

<script>
	$(document).ready(function(){
		max_page = $('#page-collections').attr('value');
		pageValue = $('#page-value');
		current = parseInt(pageValue.val());
		pageValue.val(1);
		modalContainer = $('#modal-container')
		$('#page-previous:first-child').on( "click", function() {goToPage(current-1);});
		$('#page-next:first-child').on( "click", function() {goToPage(current+1);});
		const templatePage1 = `<div class="page-item"><button class="page-link btn" type="button" onclick=goToPage(this.textContent)>`;
		const templatePage1active = `<div class="page-item active"><button class="page-link btn" type="button">`;
		const templatePage2 = `</button></div>`;
		pages = "";
		if (max_page<6) {
			pages += renderPage(1,max_page);
		} 
		else {
			if (current<4) {
				pages += renderPage(1,4);
				pages += renderEllipsis();
				pages += renderPage(max_page,max_page);
			} else if (current>max_page-3) {
				pages += renderPage(1,1);
				pages += renderEllipsis();
				pages += renderPage(max_page-3,max_page);
			} else {
				pages += renderPage(1,1);
				pages += renderEllipsis();
				pages += renderPage(current-1,current+1);
				pages += renderEllipsis();
				pages += renderPage(max_page,max_page);
			}
		}
		$(pages).insertBefore('#page-next');

		function renderPage(start,end) {
			var template = "";
			for (let i=start; i<=end; i++) {
				if (i === current) {template += templatePage1active + i + templatePage2;}
				else {template += templatePage1 + i + templatePage2;}
			}
			return template;
		}
		function renderEllipsis() {
			return templatePage1 + "..." + templatePage2;
		}
		$("#viewModal").on("hidden.bs.modal", function () {
			modalContainer.empty();
			modalContainer.append(loading);
		});
	});	
	function truncate(str, n){
		return (str.length > n) ? str.slice(0, n-1) + '&hellip;' : str;
	};
	function goToPage(page) {
		try {
			page = parseInt(page);
			if (!isFinite(page) || page<1 || page>max_page) {throw "exceed";}
			pageValue.val(page);
			document.forms.listsort.submit();
		}
		catch(err) {
			console.log(err);
			return;
		}
	}
	const loading = `<img src="/media/loading.gif" alt="Loading" style="width: 200px; height: 200px; margin-left: auto; 
    margin-right: auto; margin-top: auto; margin-bottom: auto;">`
	function viewCustomItem(custom,id) {
		$.ajax({
			url: '/view/'+custom+'/'+id,
			type: "GET",
			dataType: "json",
			success: (data) => {
				var tem = `<div class="image-container ">
					<div class="bg-image" id="modal-image" style='background-image: url("/media/`+data.image+`");'></div>
				</div>
				<div class="movie-info">
					<h2>`+data.custom+` no.`+data.id+`</h2>
					<div>
						<h1>`+data.title+`</h1><small>Released Date: 27 Nov 2013</small>
					</div>
					<h4>Rating: 7.4 / 10</h4>
					<p>`+data.description+`</p>
					<div class="tags-container"><span>Animation</span><span>Adventure</span><span>Comedy</span></div>
				</div>`
				console.log(data);
				modalContainer.empty();
				modalContainer.append(tem);
			},
			error: (error) => {console.log(error);}
		  });
	}
	
</script>
{% endverbatim script %}

<main class="container my-4">

<h3 class="my-4 border-bottom pb-1"><span class="text-muted">List of </span>{{custom}}</h3>
<form name="listsort" method="post">
{% csrf_token %}
<div class="bg-white rounded d-flex flex-wrap mt-5" id="header"> 
		<div class="d-flex align-items-center">
			<button class="btn btn-hide text-uppercase" type="submit" id="filter-btn"> 
				<span id="btn-txt">Sort</span> <span class="fa fa-angle-right" id="filter-angle"></span>
			</button>
		</div>
		<div class="d-flex align-items-center"> 
			{{ form.sort }}
		</div>
		<div class="d-inline-flex align-items-center">
			<div class="d-inline-flex" id="select2">
				Games:{{ form.n_per }}
			</div>
			<div class="font-weight-bold mx-1">from {{ count }}</div>
		</div>
		<!--hidden field for page-->
		<div><input type="hidden"  name="page" value="{{ cur_page }}" id="page-value"/></div>
		<div class="ms-auto mr-2">
			<div id="page-collections" class="pagination d-flex align-items-center" value="{{ max_page }}">
				<div class="page-item" id="page-previous"> 
					<button class="page-link btn" type="button" aria-label="Previous"> <span aria-hidden="true" class="font-weight-bold">&lt;</span> <span class="sr-only">Previous</span> </button> 
				</div>
				<div class="page-item" id="page-next"> 
					<button class="page-link btn" type="button" aria-label="Next"> <span aria-hidden="true" class="font-weight-bold">&gt;</span> <span class="sr-only">Next</span> </button> 
				</div>
			</div>
		</div>	
</div>
</form>

<div id="content" class="mx-0 my-3">
	<div class="row">
		{% if data %}
		{% for item in data %}
			<div class="col-lg-4 col-md-6 pt-2">
				<div class="card d-flex flex-column align-items-center" onclick='viewCustomItem("{{ custom }}",{{ item.id }});' data-toggle="modal" data-target="#viewModal">
					<div class="product-name">{{ item.title }}</div>
					<div class="card-img "> <img src="/media/{{item.image}}" alt=""> </div>
					{% comment %} <div class="card-body pt-4">
						<div class="d-flex align-items-center price">
						<div class="del mr-2"><span class="text-dark">5500 uah</span></div>
						<div class="font-weight-bold">4500 uah</div>
						</div>
					</div> {% endcomment %}
				</div>
			</div>
		{% endfor %}
		{% endif %}
	</div>
</div>
</main>
{% endblock %}